
# JaCoCo

[JaCoCo Doc](https://www.jacoco.org/jacoco/)  
[Gradle JacocoTaskExtension](https://docs.gradle.org/current/dsl/org.gradle.testing.jacoco.plugins.JacocoTaskExtension.html#org.gradle.testing.jacoco.plugins.JacocoTaskExtension:excludes)

> JaCoCo is a free code coverage library for Java, which has been created by the EclEmma team based on the lessons learned from using and integration existing libraries for many years.

[[Refer] Gradle 프로젝트에 JaCoCo 설정하기](https://techblog.woowahan.com/2661/)

## Gradle Task 설정

#### jacocoTestReport
- 바이너리 커버리지 결과를 사람이 읽기 좋은 형태의 리포트로 저장
- html 파일로 생성해 사람이 쉽게 눈으로 확인할 수도 있고, SonarQube 등으로 연동하기 위해 xml, csv 같은 형태로도 리포트를 생성할 수 있다.
  
#### jacocoTestCoverageVerification
  - 내가 원하는 커버리지 기준을 만족하는지 확인해 주는 task
  - 예를 들어, 브랜치 커버리지를 최소한 80% 이상으로 유지하고 싶다면, 이 task에 설정하면 된다.
  - test task처럼 Gradle 빌드의 성공/실패로 결과를 보여준다

[JacocoTaskExtension Doc](https://docs.gradle.org/current/dsl/org.gradle.testing.jacoco.plugins.JacocoTaskExtension.html)  
test task에 default로 설정된 값으로, 이 값들은 오버라이드 하여 사용  

```groovy
test {
  jacoco {
    enabled = true
    destinationFile = file("$buildDir/jacoco/$.exec")
    includes = []
    excludes = []
    excludeClassLoaders = []
    includeNoLocationClasses = false
    sessionId = "<auto-generated value>"
    dumpOnExit = true
    classDumpDir = null
    output = JacocoTaskExtension.Output.FILE
    address = "localhost"
    port = 6300
    jmx = false
  }
}
```

test task 이후 jacocoTestReport task와 jacocoTestCoverageVerification task 를 순차적으로 작업하는 것을 하나의 task로 묶음
```groovy
task testCoverage(type: Test) {
    group 'verification'
    description 'Runs the unit tests with coverage'

    dependsOn('test',
            'jacocoTestReport',
            'jacocoTestCoverageVerification')

    tasks['jacocoTestReport'].mustRunAfter(tasks['test'])
    tasks['jacocoTestCoverageVerification'].mustRunAfter(tasks['jacocoTestReport'])
}
```

test task 이후 jacocoTestReport task를 강제한다.  
또한 jacocoTestReport 이후 jacocoTestCoverageVerification를 강제할 수도 있다.
```groovy
test {
    finalizedBy 'jacocoTestReport'
}

// jacocoTestReport {
//     finalizedBy 'jacocoTestCoverageVerification'
// }
```

## 커버리지 기준

JaCoCo는 여러 룰을 위한하는 경우 처음 위반한 룰만 리포팅

### [Element](https://www.eclemma.org/jacoco/trunk/doc/api/org/jacoco/core/analysis/ICoverageNode.ElementType.html)

- BUNDLE (default): 패키지 번들
- PACKAGE: 패키지
- CLASS: 클래스
- SOURCEFILE: 소스파일
- METHOD: 메소드

### [Counter](https://www.eclemma.org/jacoco/trunk/doc/api/org/jacoco/core/analysis/ICoverageNode.CounterEntity.html) ([Doc](https://www.eclemma.org/jacoco/trunk/doc/counters.html))

- LINE: 빈 줄을 제외한 실제 코드의 라인 수
- BRANCH: 조건문 등의 분기 수
- CLASS: 클래스 수
- METHOD: 메소드 수
- INSTRUCTION (default): Java 바이트코드 명령 수. [Java bytecode instruction listings](https://en.wikipedia.org/wiki/List_of_Java_bytecode_instructions)
- COMPLEXITY: 복잡도. 자세한 복잡도 계산은 Coverage Counters – JaCoCo docs 참고

### [Value](https://www.eclemma.org/jacoco/trunk/doc/api/org/jacoco/core/analysis/ICounter.CounterValue.html)

- TOTALCOUNT: 전체 개수
- MISSEDCOUNT: 커버되지 않은 개수
- COVEREDCOUNT: 커버된 개수
- MISSEDRATIO: 커버되지 않은 비율. 0부터 1 사이의 숫자로, 1이 100%.
- COVEREDRATIO (default): 커버된 비율. 0부터 1 사이의 숫자로, 1이 100%.

### Example

> 커버리지 수치는 BigDecimal을 강제.  
> 내가 지정한 유효자리수 까지만 표기가 되며, 그 자리수를 넘어가면 반올림.  
> 샘플에서 설정한 라인 커버리지 80%를 0.80 대신 0.8로 쓰게 되면, 0.42가 아닌 0.4로 표시.  

```groovy
jacocoTestCoverageVerification {
  violationRules {
    rule {
      // 'element'가 없으면 프로젝트의 전체 파일을 합친 값을 기준으로 합니다.
      // 위의 리포트에서 'Total'로 표시된 부분입니다.
      limit {
        // 'counter'를 지정하지 않으면 default는 'INSTRUCTION'
        // 'value'를 지정하지 않으면 default는 'COVEREDRATIO'
        minimum = 0.30
      }
    }

    // 여러 룰을 생성할 수 있습니다.
    rule {
      // 룰을 간단히 켜고 끌 수 있습니다.
      enabled = true

      // 룰을 체크할 단위는 클래스 단위
      element = 'CLASS'

      // 브랜치 커버리지를 최소한 90% 만족시켜야 합니다.
      limit {
        counter = 'BRANCH'
        value = 'COVEREDRATIO'
        minimum = 0.90
      }

      // 라인 커버리지를 최소한 80% 만족시켜야 합니다.
      limit {
        counter = 'LINE'
        value = 'COVEREDRATIO'
        minimum = 0.80
      }

      // 빈 줄을 제외한 코드의 라인수를 최대 200라인으로 제한합니다.
      limit {
        counter = 'LINE'
        value = 'TOTALCOUNT'
        maximum = 200
      }
    }
  }
}
```

## 테스트 제외

> QueryDsl을 사용하면 자동으로 생성되는 구현체인 Q*.class 같은 파일이나, spring-batch 등의 배치 설정 파일 커버리지 체크 제외 필요시  
> excludes로 제외할 클래스명을 지정할 수 있고, 와일드카드(* 과 ?)를 사용.

```groovy
jacocoTestCoverageVerification {
  violationRules {
    rule {
      element = 'CLASS'

      limit {
        counter = 'LINE'
        value = 'TOTALCOUNT'
        maximum = 8
      }

      // 커버리지 체크를 제외할 클래스들
      excludes = [
        '**/Q*.java',
        '**/*Generated.java'
      ]
    }
  }
}
```

![jacoco-html](./img/jacoco-html.png)  
![/jacocoTestCoverageVerification](./img/jacocoTestCoverageVerification.png)

---
